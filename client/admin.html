<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin</title>
  <link rel="stylesheet" href="admin.css">
</head>
<body>
  <div class="container">
    <h1>Admin Panel</h1>

    <!-- Back button -->
    <div class="row">
      <a class="link" href="stores.html">Back</a>
    </div>

    <!-- User list -->
    <h3>Users</h3>
    <div id="users"></div>

    <!-- Create new user form -->
    <h3>Create User (Admin only)</h3>
    <form id="createForm">
      <input id="name" placeholder="Name (20-60)" />
      <input id="email" placeholder="Email" />
      <input id="password" placeholder="Password" />
      
      <select id="role">
        <option>USER</option>
        <option>OWNER</option>
        <option>ADMIN</option>
      </select>

      <div class="row">
        <button type="submit">Create</button>
      </div>

      
      <div id="msg" class="alert"></div>
    </form>
  </div>

  <script>
    
    const token = localStorage.getItem('token');
    if (!token) { 
      alert('Please login as admin');
      window.location = 'login.html';
    }

    
    async function loadUsers() {
      const res = await fetch('/api/admin/users', {
        headers: { 'Authorization': 'Bearer ' + token }
      });

      
      if (!res.ok) { 
        alert('Not authorized');
        window.location = 'stores.html';
        return;
      }

      
      const rows = await res.json();

      
      const el = document.getElementById('users');
      el.innerHTML = rows.map(u => `
        <div class="card">
          <b>${u.name}</b>
          <div class="small">${u.email} - ${u.role}</div>
        </div>
      `).join('');
    }

    
    document.getElementById('createForm').onsubmit = async (e) => {
      e.preventDefault();

      
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const role = document.getElementById('role').value;

      try {
        
        const res = await fetch('/api/admin/create-user', {
          method:'POST',
          headers:{ 
            'Content-Type':'application/json', 
            'Authorization': 'Bearer ' + token 
          },
          body: JSON.stringify({ name, email, password, role })
        });

        const data = await res.json();

        
        if (!res.ok) {
          document.getElementById('msg').textContent = data.error || 'Error';
          return;
        }

        
        document.getElementById('msg').textContent = 'User Created';

        
        loadUsers();

      } catch (err) {
        document.getElementById('msg').textContent = 'Network error';
      }
    };

    
    loadUsers();
  </script>
</body>
</html>
