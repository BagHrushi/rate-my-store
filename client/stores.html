<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Stores</title>
  <link rel="stylesheet" href="stores.css">
</head>
<body>
<div class="container">
  <h1>Stores</h1>

  <!-- Navigation bar -->
  <div class="nav">
    <a class="link" href="index.html">Home</a>
    <a class="link" href="create_store.html">Create Store (Owner)</a>
    <a class="link" href="admin.html">Admin (if admin)</a>
    <span id="userInfo" class="small"></span>
    <button id="logoutBtn" style="margin-left:auto;">Logout</button>
  </div>

  <!-- Search & Sorting options -->
  <div class="controls">
    <input id="q" placeholder="Search by name or address" />
    <select id="sort">
      <option value="avg_desc">Top rated</option>
      <option value="avg_asc">Lowest rated</option>
      <option value="name_asc">Name A→Z</option>
      <option value="name_desc">Name Z→A</option>
    </select>
    <button id="searchBtn">Search</button>
  </div>

  
  <div id="list"></div>
</div>

<script>
  const base = '/api';   
  const token = () => localStorage.getItem('token'); 

  // Logout: clear token & go back to home page
  document.getElementById('logoutBtn').onclick = () => {
    localStorage.removeItem('token');
    window.location = 'index.html';
  };

  // Load current logged-in user info
  async function loadMe() {
    const t = token();
    if (!t) {
      document.getElementById('userInfo').textContent = 'Not logged in';
      return;
    }
    try {
      const res = await fetch(base + '/me', { headers: { 'Authorization': 'Bearer ' + t }});
      if (!res.ok) {
        localStorage.removeItem('token');
        return;
      }
      const user = await res.json();
      document.getElementById('userInfo').textContent = 
        `Logged in as ${user.name} (${user.role})`;
    } catch(e) {
      console.log("Error loading user");
    }
  }

  // Fetch stores from backend and display them
  async function fetchStores() {
    const searchText = encodeURIComponent(document.getElementById('q').value || '');
    const sortOption = document.getElementById('sort').value;

    const res = await fetch(`${base}/stores?q=${searchText}&sort=${sortOption}`);
    const stores = await res.json();
    const list = document.getElementById('list');
    list.innerHTML = '';

    // If no stores found
    if (!stores.length) {
      list.innerHTML = '<p class="small">No stores found.</p>';
      return;
    }

    // Loop through each store and show details
    for (const store of stores) {
      const div = document.createElement('div');
      div.className = 'card';

      // store details + rating buttons
      div.innerHTML = `
        <strong>${store.name}</strong> <span class="small">(${store.email})</span>
        <div class="small">${store.address || ''}</div>
        <div class="small">Average: <b>${store.avg_score}</b> (${store.total_ratings} ratings)</div>
        <div id="rate-${store.id}" style="margin-top:8px;">
          <label class="small">Your rating:</label>
          <div class="row" id="rateRow-${store.id}">
            ${[1,2,3,4,5].map(n => 
              `<button class="rate-btn" data-id="${store.id}" data-score="${n}">${n}★</button>`
            ).join('')}
            <button data-id="${store.id}" class="link viewResults">View results</button>
          </div>
          <div id="result-${store.id}" class="small"></div>
        </div>
      `;
      list.appendChild(div);
    }

    // Handle rating buttons
    document.querySelectorAll('.rate-btn').forEach(btn => {
      btn.onclick = async (e) => {
        const storeId = e.target.dataset.id;
        const score = e.target.dataset.score;
        const t = token();
        if (!t) {
          alert('Please login to rate');
          window.location='login.html';
          return;
        }
        try {
          const res = await fetch(base + '/stores/' + storeId + '/rate', {
            method:'POST',
            headers: { 
              'Content-Type':'application/json', 
              'Authorization': 'Bearer ' + t 
            },
            body: JSON.stringify({ score })
          });
          const data = await res.json();
          if (!res.ok) return alert(data.error || 'Error');
          document.getElementById('result-' + storeId).textContent = 
            `New average: ${data.avg} (${data.total} ratings)`;
        } catch (err) { 
          alert('Network error'); 
        }
      };
    });

    // Handle "View results" button
    document.querySelectorAll('.viewResults').forEach(btn => {
      btn.onclick = async (e) => {
        const id = e.target.dataset.id;
        const res = await fetch(base + '/stores/' + id + '/results');
        const data = await res.json();
        alert('Average: ' + data.average + 
              '\nTotal: ' + data.total + 
              '\nBreakdown: ' + data.breakdown.map(r => `${r.score}: ${r.count}`).join(', ')
        );
      };
    });
  }

  // Attach search button
  document.getElementById('searchBtn').onclick = fetchStores;

  // Run on page load
  window.onload = async () => { 
    await loadMe(); 
    await fetchStores(); 
  };
</script>
</body>
</html>
